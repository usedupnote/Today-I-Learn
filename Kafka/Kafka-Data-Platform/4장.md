# `4장: 카프카 프로듀서`

## `4.4 프로듀서 주요 옵션`

### `acks`

프로듀서가 카프카 토픽의 리더에게 메세지를 보낸 후 요청을 완료하기 전 `ack(승인)`의 수입니다. 해당 옵션의 수가 작으면 성능이 좋지만, 메세지 손실 가능성이 있고, 반대로 수가 크면 성능이 좋지 않지만 메세지 손실 가능성도 줄어들거나 없어집니다.

<br>

#### `acks=0`

프로듀서는 서버로부터 어떠한 ack도 기다리지 않습니다. 이 경우 서버가 데이터를 받았는지 보장하지 않고, 클라이언트는 전송 실패에 대한 결과를 알지 못하기 때문에 재요청 설정도 적용되지 않습니다. 메세지가 손실될 수 있지만, 서버로부터 ack에 대한 응답을 기다리지 않기 때문에 매우 빠르게 메세지를 보낼 수 있어 높은 처리량을 얻을 수 있다.

<br>

#### `acks=1`

1로 설정하는 경우 리더는 데이터를 기록하지만, 모든 팔로워는 확인하지 않습니다. 이 경우 일부 데이터의 손실이 발생할 수 있습니다.

<br>

#### `acks=all 또는 -1`

리더는 ISR의 팔로워로부터 데이터에 대한 ack를 기다립니다. 하나의 팔로워가 있는 한 데이터는 손실되지 않으며, 데이터 무손실에 대해 가장 강력하게 보장합니다.

> ISR이란 In Sync Replica의 약어로 현재 리플리케이션이 되고 있는 리플리케이션 그룹(replication group)을 의미합니다. 

<br>

### `프로듀셔의 acks=all과 브로커의 min.insync.replicas=1`

메세지 손실을 허용하지 않도록 프로듀서의 acks 설정은 all로 지정을 합니다. 브로커의 설정은 환경설정 파일인 `server.properties`에서 설정을 변경할 수 있습니다. 

최소 리플리케이션 팩터를 지정하는 옵션은 `min.insync.replicas` 입니다. 

<br>

### `프로듀서의 acks=all과 브로커의 min.insync.replicas=2`

1. 프로듀서가 `acks=all` 옵션으로 리더에게 메세지를 보냅니다.
2. 리더는 메세지를 받은 후 저장하고, 브로커 1에 있는 팔로워는 변경된 사항이나 새로 받은 메세지가 없는지를 리더로부터 주기적으로 확인하면서, 새로운 메세지가 전송된 것을 확인하면 자신도 리더로부터 메세지를 가져와 저장합니다.
3. 리더는 `min.insync.replicas`가 2로 설정되어 있기 때문에 acks를 보내기 전 최소 2개의 리플리케이션을 유지하는지 확인합니다.
4. 리더는 프로듀서가 전송한 메세지에 대해 acks를 프로듀서에게 보냅니다.

손실 없는 메세지 전송을 위해 프로듀서가 `acks=all` 옵션으로 메세지를 전송했고, 프로듀서는 acks를 받았습니다. 만약 리더가 acks를 보내자마자 아주 예외적인 경우로 리더 선출 작업이 발생해도 그 메세지를 가지고 있는 팔로워가 있기 때문에 메세지 손실은 발생하지 않습니다.

`아파치 카프카 문서에서는 손실 없는 메세지 전송을 위한 조건으로 프로듀서는 acks=all, 브로커의 min.insync.replicas=2, 토픽의 리플리케이션 팩터리는 3`으로 권장하고 있습니다.

> 참고로 `Replication Factor` 는 토픽의 파티션의 복제본을 몇 개를 생성할 지에 대한 설정입니다.

<br>

### `프로듀서의 acks=all과 브로커의 min.insync.replicas=3`

손실 없는 메세지 전송을 위해 `min.insync.replicas=3`으로 설정해야 하는 것이 아닌가라고 생각할 수 있습니다. 왜 `min.insync.replicas=2`로 설정해야 하는지 알아보겠습니다.

`min.insync.replicas=3`으로 설정되어 있다고 가정하겠습니다. 

1. 프로듀서가 `acks=all` 옵션으로 리더에게 메세지를 보냅니다. 
2. 리더는 메세지를 받은 후에 저장합니다. 브로커 1에 있는 팔로워는 변경된 사항이나 새로 받은 메세지가 없는지를 리더로부터 주기적으로 확인하면서, 새로운 메세지가 전송된 것을 확인하면 자신도 리더로부터 메세지를 가져와서 저장합니다.
3. 리더는 `min.insync.replicas`가 3으로 설정되어 있기 때문에 `acks`를 보내기 전 최소 3개의 복제를 유지하는지 확인해야 합니다.
4. 리더는 프로듀서가 전송한 메세지에 대해 acks를 프로듀서에게 보냅니다.

`min.insync.replicas`를 3으로 올리는 것이 더 좋아보이는데 왜 3이 아닌 2로 권장하는 것일까요? 

하나의 시나리오를 생각해보겠습니다.

1. 프로듀서는 `acks=all` 옵션으로 메세지를 전송합니다.
2. 브로커 중 팔로워가 위치하고 있는 브로커 하나를 강제로 종료합니다.
3. 카프카 서버의 로그를 확인합니다.

<br>

팔로워 중에 하나인 브로커를 강제 종료하고 에러 로그를 확인해보면 `리플리케이션 팩터가 부족하다`는 내용의 메세지가 나타나게 될 것인데요. 

왜 이러한 로그들이 발생하는지 알아보면 우리는 `acks=all, min.insync.replicas=3`으로 설정했습니다. 이렇게 설정한 경우 프로듀서가 토픽의 리더에게 메세지를 전송하게 되면, 리더 + 팔로워 + 팔로워 이렇게 3곳에서 모두 메세지를 받아야만 리더는 프로듀서에게 메세지를 잘 받았다는 `확인(ack)`을 보낼 수 있습니다.

하지만 여기서 팔로워 중에 하나인 브로커 하나에 문제가 발생했으니 ISR에는 리더와 팔로워 하나만 남아 있습니다. 결국 옵션으로 설정한 조건을 충족시킬 수 없는 상황이 발생했기 때문에 위오 같은 에러 로그가 발생하는 것입니다.

카프카는 브로커 하나가 다운되더라도 크리티컬한 장애 상황없이 서비스를 잘 처리할 수 있도록 구성되어 있는데, 만약 `acks=all + min.insync.replicas=3`으로 설정하게 되면 브로커 하나만 다운되더라도 카프카 메세지를 보낼 수 없는 클러스터 전체 장애와 비슷한 상황이 발생하게 됩니다.

`이러한 이유로 카프카에서는 손실없는 메세지 전송을 위해 프로듀서의 acks=all로 사용하는 경우 브로커의 min.insync.replicas=2로 설정하고 토픽의 리플리케이션 팩터는 3으로 설정하기를 권장하고 있습니다.`
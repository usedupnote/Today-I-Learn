## `ElasticSearch 처음 사용할 때 알면 좋은 것들`

엘라스틱서치를 이해하기 위해서는 `인덱스(index)`와 `도큐먼트(document)`가 매우 중요하다. 

- `인덱스`: 도큐먼트를 저장하는 논리적 구분자
- `도큐먼트`: 실제 데이터를 저장하는 단위

정리하면 `인덱스 내부에는 JSON 형태로 된 다수의 도큐먼트가 존재하고 도큐먼트는 복수의 필드를 갖는다.`

<br>

## `도큐먼트`

도큐먼트는 엘라스틱서치에서 데이터가 저장되는 기본 단위로 JSON 형태이며, 하나의 도큐먼트에는 여러 필드와 값을 갖는다.

| MySQL | 엘라스틱서치 |
|-------|--------|
| 테이블   | 인덱스    |
| 레코드   | 도큐먼트   |
| 컬럼    | 필드     |
| 스키마   | 매핑     |

```json
{
  "name": "Gyunny",
  "age": 25,
  "gender": "male"
}
```

<br>

## `인덱스`

인덱스는 도큐먼트를 저장하는 논리적 단위로, `관계형 데이터베이스의 테이블과 유사한 개념`이다. 하나의 인덱스에 다수의 도큐먼트가 포함되는 형태인데, 동일한 인덱스에 있는 도큐먼트는 동일한 스키마를 갖는다.

같은 형태의 스키마를 같은 인덱스에 저장하는 것이 일반적이다. 즉, 서로 다른 스키마를 가진 도큐먼트를 하나의 인덱스에 저장하는 방법은 바람직하지 않다. (왜 그런 것인지 좀 더 이유 명확하게 정리 필요) 

<br>

### `관리 목적의 그룹핑`

기본적으로 인덱스는 용량이나 숫자 제한 없이 무한대의 도큐먼트를 포함할 수 있다. 따라서 이론적으로는 하나의 인덱스에 수억 개의 도큐먼트도 저장될 수 있다. 하지만 인덱스가 커지면 검색 시 많은 도큐먼트를 참조해야 하기 때문에 성능이 나빠진다.

그래서 인덱스 용량 제한을 두고, 특정 도큐먼트 개수에 도달하거나 특정 용량을 넘어서면 인덱스를 분리한다. 

<br>

## `인덱스 생성/확인/삭제`

```
PUT index1  // 인덱스 생성
```

```
GET index1 // 인덱스 조회
```

```
DELETE index1 // 인덱스 삭제
```



<br>

## `도큐먼트 생성`

도큐먼트는 반드시 하나의 인덱스에 포함되어야 한다. 엘라스틱서치에서 도큐먼트를 인덱스에 포함시키는 것을 `인덱싱`이라고 한다.

```
PUT index2_doc/1
```
```json
{
  "name": "mike",
  "age": 25,
  "gender": "male"
}
```

<br>

## `도큐먼트 읽기`

도큐먼트를 읽는 방법은 크게 도큐먼트 아이디를 이용해 조회하는 방법과 쿼리 DSL 이라는 엘라스틱서치가 제공하는 쿼리문을 이용해 검색하는 방법이 있다.

```
GET index2/_doc/1
```

인덱스명과 도큐먼트 아이디로 특정 도큐먼트의 데이터를 가져올 수 있다.

<br>

```
GET index2/_search
```

`엘라스틱 search DSL` 쿼리를 사용하면 index2 인덱스 내의 모든 도큐먼트를 가져온다. 

<br>

## `매핑`

관계형 데이터베이스는 테이블을 만들 때 반드시 스키마 설계가 필요한 것처럼 엘라스틱 서치도 매핑 작업이 필요하다.  

매핑을 쉽게 말하면 `JSON 형태의 데이터를 루씬이 이해할 수 있도록 바꿔주는 작업`이다.

엘라스틱서치가 검색 엔진으로 전문 검색과 대용량 데이터를 빠르게 실시간 검색할 수 있는 이유는 매핑이 있기 때문인데 매핑을 `엘라스틱서치가 자동으로 하면 다이내믹 매핑`, `사용자가 직접 설명하면 명시적 매핑`이다.

<br>

## `다이내믹 매핑`

엘라스틱서치의 모든 인덱스는 매핑 정보를 갖고 있지만 유연한 활용을 위해 인덱스 생성 시 매핑 정의를 강제하지는 않는다.

즉, 인덱스에 도큐먼트가 저장될 때 JSON 필드의 타입을 보고 엘라스틱 서치가 다이내믹 매핑을 해주는 것이다.

<br>

## `명시적 매핑`

인덱스 매핑을 직접 정의하는 것을 `명시적 매핑`이라고 한다.

<br>

## `인덱스 템플릿이란?`

인덱스 템플릿은 주로 설정이 동일한 복수의 인덱스를 만들 때 사용한다. 인덱스 별로 설정이 동일해야 파티셔닝 할 수 있다. 만약 인덱스 템플릿이 없다면 인덱스마다 설정을 적용해야 하는데, 이러면 실수할 수도 있고 쉽지 않다.

<br>

### `템플릿 확인`

```
GET _index_template
```

- 전체 인덱스 템플릿 검색

<br>

```
GET _index_template/gyunny
```

- `gyunny` 인덱스 템플릿 검색

<br>

### `템플릿 생성`

```
PUT _index_template/test_template
{
  "index_patterns": ["test_*"],
  "priority": 1,
  "templates": {
    "settings": {
      "number_of_shards: 3,
      "number_of_replicas: 1
    },
    "mappings": {
       "properties": {
          "name": {"type": "text"},
          "age: {"type: "short"},
       }
    }
  }
}
```

`index_patterns`, `priority`, `templates`은 템플릿에서 사용하는 파라미터로 인덱스 템플릿을 생성하는데 중요한 파라미터이다.

<br>

| 파라미터           | 설명                                                      |
|----------------|---------------------------------------------------------|
| index_patterns | 새로 만들어지는 인덱스 중에 이름이 인덱스 패턴과 매칭되는 경우 이 템플릿이 적용된다.        |
| priority       | 인덱스 생성 시 이름에 매칭되는 템플릿이 둘 이상일 때 템플릿이 적용되는 우선순위를 정할 수 있다. |
| template       | 새로 생성되는 인덱스에 적용되는 settings, mappings 같은 인덱스 설정을 정의한다.   |

<br>

### `템플릿 삭제`

템플릿을 지워도 기존 인덱스들은 영향을 받지 않는다. 이미 만들어진 인덱스들이 변경되는 것이 아니고 단순히 템플릿이 지워지는 것뿐이다. 

<br>

## `분석기`

엘라스틱서치는 전문 검색을 지원하기 위해 `역인덱싱 기술`을 사용한다.

> 전문 검색은 장문의 문자열에서 부분 검색을 수행하는 것이며, 역인덱싱은 장문의 문자열을 분석해 작은 단위로 쪼개어 인덱싱하는 기술이다.

```
캐릭터 필터 -> 토크나이저 -> 토큰 필터
```

역인덱싱을 이용한 전문 검색에서 양질의 결과를 얻기 위해서는 문자열을 나누는 기준이 중요하며, 이를 지원하기 위해 엘라스틱 서치는 `캐릭터 필터`, `토크나이저`, `토큰 필터`로 구성되어 있는 분석기 모듈이 존재한다.

| 구성요소  | 설명                                               |
|-------|--------------------------------------------------|
| 캐릭터 필터 | 입력받은 문자열을 변경하거나 불필요한 문자열을 제거한다.                  |
| 토크나이저 | 문자열을 토큰으로 분리한다. 분리할 때 토큰의 순서나 시작, 끝 위치도 중요하다.    |
| 토큰 필터 | 분리된 토큰들의 필터 작업을 한다. 대소문자 구분, 형태소 분석 등의 작업이 가능하다. |